name: Sync to Feishu

on:
  push:
    paths:
      - 'docs/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: docs/**.md
      
      - name: Get Feishu Token
        id: token
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"app_id\":\"${{ secrets.FEISHU_APP_ID }}\",\"app_secret\":\"${{ secrets.FEISHU_APP_SECRET }}\"}" \
            https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal)
          token=$(echo "$response" | jq -r '.tenant_access_token')
          echo "token=$token" >> $GITHUB_OUTPUT
          echo "Token got."
      
      - name: Send to Feishu
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          FEISHU_TOKEN: ${{ steps.token.outputs.token }}
          FEISHU_RECEIVE_ID: ${{ secrets.FEISHU_RECEIVE_ID }}
          REPO_URL: https://github.com/${{ github.repository }}/blob/main
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            
            # 1. è¯»å–æ–‡ä»¶å†…å®¹ (å‰ 10 è¡Œ)
            raw_content=$(cat "$file" | head -10)
            
            # 2. ä½¿ç”¨ jq æ„å»ºå¡ç‰‡å†…å®¹ (Card Payload)
            # æ³¨æ„ï¼šè¿™é‡Œæ„å»ºçš„æ˜¯å¡ç‰‡çš„ JSON å¯¹è±¡
            card_json=$(jq -n \
              --arg filename "$filename" \
              --arg content "$raw_content" \
              --arg url "$REPO_URL/$file" \
              '{
                "card": {
                  "header": {
                    "title": {
                      "tag": "plain_text",
                      "content": ("ğŸ“š " + $filename)
                    },
                    "template": "blue"
                  },
                  "elements": [
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": $content
                      }
                    },
                    {
                      "tag": "action",
                      "actions": [
                        {
                          "tag": "button",
                          "text": {
                            "tag": "plain_text",
                            "content": "æŸ¥çœ‹åŸæ–‡"
                          },
                          "url": $url,
                          "type": "primary"
                        }
                      ]
                    }
                  ]
                }
              }')
            
            # 3. ã€å…³é”®æ­¥éª¤ã€‘å°†å¡ç‰‡ JSON å†æ¬¡åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
            # é£ä¹¦è¦æ±‚ content å­—æ®µæ˜¯ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ JSON å¯¹è±¡
            # jq -c . å¯ä»¥å‹ç¼©å¹¶è¾“å‡ºä¸ºå•è¡Œå­—ç¬¦ä¸²ï¼Œjq -R . å¯ä»¥å°†è¾“å…¥è¯»å–ä¸ºåŸå§‹å­—ç¬¦ä¸²
            # è¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠ card_json è¿™ä¸ªå˜é‡å˜æˆä¸€ä¸ªåˆæ³•çš„ JSON å­—ç¬¦ä¸²å€¼
            content_string=$(echo "$card_json" | jq -R .)
            
            # 4. æ„å»ºæœ€ç»ˆå‘é€çš„æ¶ˆæ¯ä½“
            # receive_id å’Œ msg_type æ˜¯å¤–å±‚å­—æ®µ
            # content å­—æ®µå¡«å…¥åˆšæ‰ç”Ÿæˆçš„å­—ç¬¦ä¸²
            final_payload=$(jq -n \
              --arg receive_id "$FEISHU_RECEIVE_ID" \
              --arg content_str "$content_string" \
              '{
                "receive_id": $receive_id,
                "msg_type": "interactive",
                "content": ($content_str | fromjson) 
              }')
              
            # âš ï¸ ä¿®æ­£ï¼šä¸Šé¢çš„ fromjson å¯èƒ½ä¼šå†æ¬¡æŠŠå­—ç¬¦ä¸²è½¬å›å¯¹è±¡ã€‚
            # è®©æˆ‘ä»¬ç”¨æœ€ç¬¨ä½†æœ€ç¨³å¦¥çš„æ–¹æ³•ï¼šç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œç¡®ä¿ content æ˜¯å­—ç¬¦ä¸²æ ¼å¼
            # é‡æ–°æ„å»º final_payloadï¼Œè¿™æ¬¡æ‰‹åŠ¨ç¡®ä¿ content æ˜¯å­—ç¬¦ä¸²
            final_payload=$(jq -n \
              --arg receive_id "$FEISHU_RECEIVE_ID" \
              --argjson card_obj "$card_json" \
              '{
                "receive_id": $receive_id,
                "msg_type": "interactive",
                "content": ($card_obj | @json)
              }')

            echo "Sending: $filename"
            # è°ƒè¯•ï¼šæ‰“å°æœ€ç»ˆ payload çš„å‰ 200 ä¸ªå­—ç¬¦ï¼Œç¡®è®¤ content æ˜¯å­—ç¬¦ä¸²
            # echo "Payload preview: $(echo "$final_payload" | head -c 200)..." 
            
            # 5. å‘é€è¯·æ±‚
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer $FEISHU_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$final_payload" \
              "https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=open_id")
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            if [ "$http_code" == "200" ]; then
              code=$(echo "$body" | jq -r '.code')
              if [ "$code" == "0" ]; then
                echo "âœ… Success! Message sent to Feishu."
              else
                echo "âŒ Feishu API Error: $body"
                exit 1
              fi
            else
              echo "âŒ HTTP Request Failed: $http_code"
              echo "Response: $body"
              exit 1
            fi
          done
