name: Sync to Feishu

on:
  push:
    paths:
      - 'docs/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: docs/**.md
      
      - name: Get Feishu Token
        id: token
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"app_id\":\"${{ secrets.FEISHU_APP_ID }}\",\"app_secret\":\"${{ secrets.FEISHU_APP_SECRET }}\"}" \
            https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal)
          token=$(echo "$response" | jq -r '.tenant_access_token')
          echo "token=$token" >> $GITHUB_OUTPUT
          echo "Token got."
      
      - name: Send to Feishu
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          FEISHU_TOKEN: ${{ steps.token.outputs.token }}
          FEISHU_RECEIVE_ID: ${{ secrets.FEISHU_RECEIVE_ID }}
          REPO_URL: https://github.com/${{ github.repository }}/blob/main
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            
            # 1. è¯»å–å†…å®¹å¹¶æ¸…æ´—
            # head -5: åªå–å‰ 5 è¡Œï¼Œé˜²æ­¢å¤ªé•¿
            # tr '\n' ' ': æŠŠæ¢è¡Œç¬¦å˜æˆç©ºæ ¼ï¼Œå½»åº•è§£å†³å¤šè¡Œé—®é¢˜
            # sed 's/"/\\"/g': æŠŠåŒå¼•å·è½¬ä¹‰ï¼Œé˜²æ­¢ç ´å JSON ç»“æ„
            # sed "s/'/\\\\'/g": æŠŠå•å¼•å·ä¹Ÿè½¬ä¹‰ä¸€ä¸‹ï¼Œä»¥é˜²ä¸‡ä¸€
            content=$(cat "$file" | head -5 | tr '\n' ' ' | sed 's/"/\\"/g' | sed "s/'/\\\\'/g")
            
            echo "Sending notification for: $filename"
            
            # 2. ç›´æ¥æ‹¼æ¥ JSON å­—ç¬¦ä¸²
            # æ³¨æ„ï¼šè¿™é‡Œ content å˜é‡ç›´æ¥åµŒå…¥ï¼Œå› ä¸ºå®ƒå·²ç»è¢«æ¸…æ´—è¿‡ï¼Œæ˜¯å®‰å…¨çš„å•è¡Œå­—ç¬¦ä¸²
            JSON_PAYLOAD="{
              \"receive_id\": \"$FEISHU_RECEIVE_ID\",
              \"msg_type\": \"interactive\",
              \"content\": {
                \"card\": {
                  \"header\": {
                    \"title\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ“š $filename\"
                    },
                    \"template\": \"blue\"
                  },
                  \"elements\": [
                    {
                      \"tag\": \"div\",
                      \"text\": {
                        \"tag\": \"lark_md\",
                        \"content\": \"$content\"
                      }
                    },
                    {
                      \"tag\": \"action\",
                      \"actions\": [
                        {
                          \"tag\": \"button\",
                          \"text\": {
                            \"tag\": \"plain_text\",
                            \"content\": \"æŸ¥çœ‹åŸæ–‡\"
                          },
                          \"url\": \"$REPO_URL/$file\",
                          \"type\": \"primary\"
                        }
                      ]
                    }
                  ]
                }
              }
            }"
            
            # 3. å‘é€è¯·æ±‚
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer $FEISHU_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD" \
              "https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=open_id")
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            if [ "$http_code" == "200" ]; then
              code=$(echo "$body" | jq -r '.code')
              if [ "$code" == "0" ]; then
                echo "âœ… Success! Message sent."
              else
                echo "âŒ Feishu Error: $body"
                exit 1
              fi
            else
              echo "âŒ HTTP Error: $http_code"
              echo "Response: $body"
              exit 1
            fi
          done
