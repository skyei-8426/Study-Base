name: Sync to Feishu

on:
  push:
    paths:
      - 'docs/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: docs/**.md
      
      - name: Get Feishu Token
        id: token
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"app_id\":\"${{ secrets.FEISHU_APP_ID }}\",\"app_secret\":\"${{ secrets.FEISHU_APP_SECRET }}\"}" \
            https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal)
          token=$(echo "$response" | jq -r '.tenant_access_token')
          echo "token=$token" >> $GITHUB_OUTPUT
      
      - name: Send to Feishu
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          FEISHU_TOKEN: ${{ steps.token.outputs.token }}
          FEISHU_RECEIVE_ID: ${{ secrets.FEISHU_RECEIVE_ID }}
          REPO_URL: https://github.com/${{ github.repository }}/blob/main
          FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          # ä½¿ç”¨ Python è„šæœ¬æ„å»ºå’Œå‘é€æ¶ˆæ¯ï¼Œå½»åº•è§£å†³è½¬ä¹‰é—®é¢˜
          python3 - <<EOF
          import os
          import json
          import urllib.request
          import urllib.error

          token = os.environ["FEISHU_TOKEN"]
          receive_id = os.environ["FEISHU_RECEIVE_ID"]
          repo_url = os.environ["REPO_URL"]
          files = os.environ["FILES"].split()

          url = "https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=open_id"

          for file in files:
              filename = os.path.basename(file)
              
              # è¯»å–æ–‡ä»¶å‰ 5 è¡Œ
              try:
                  with open(file, 'r', encoding='utf-8') as f:
                      content = "".join([line for line in f.readlines()[:5]])
              except Exception as e:
                  content = f"Error reading file: {e}"

              # æ„å»ºå¡ç‰‡ç»“æ„
              card = {
                  "card": {
                      "header": {
                          "title": {
                              "tag": "plain_text",
                              "content": f"ğŸ“š {filename}"
                          },
                          "template": "blue"
                      },
                      "elements": [
                          {
                              "tag": "div",
                              "text": {
                                  "tag": "lark_md",
                                  "content": content
                              }
                          },
                          {
                              "tag": "action",
                              "actions": [
                                  {
                                      "tag": "button",
                                      "text": {
                                          "tag": "plain_text",
                                          "content": "æŸ¥çœ‹åŸæ–‡"
                                      },
                                      "url": f"{repo_url}/{file}",
                                      "type": "primary"
                                  }
                              ]
                          }
                      ]
                  }
              }

              # æ„å»ºæœ€ç»ˆ Payload
              # æ³¨æ„ï¼šcontent å­—æ®µå¿…é¡»æ˜¯å­—ç¬¦ä¸²åŒ–çš„ JSON
              payload = {
                  "receive_id": receive_id,
                  "msg_type": "interactive",
                  "content": json.dumps(card)  # json.dumps è‡ªåŠ¨å¤„ç†æ‰€æœ‰è½¬ä¹‰
              }

              # å‘é€è¯·æ±‚
              req = urllib.request.Request(
                  url,
                  data=json.dumps(payload).encode('utf-8'),
                  headers={
                      "Authorization": f"Bearer {token}",
                      "Content-Type": "application/json"
                  },
                  method="POST"
              )

              print(f"Sending: {filename}")
              
              try:
                  with urllib.request.urlopen(req) as response:
                      result = json.loads(response.read().decode('utf-8'))
                      if result.get("code") == 0:
                          print("âœ… Success! Message sent.")
                      else:
                          print(f"âŒ Feishu Error: {result}")
                          exit(1)
              except urllib.error.HTTPError as e:
                  print(f"âŒ HTTP Error: {e.code}")
                  print(f"Response: {e.read().decode('utf-8')}")
                  exit(1)
EOF
