name: Sync to Feishu

on:
  push:
    paths:
      - 'docs/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: docs/**.md
      
      - name: Get Feishu Token
        id: token
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"app_id\":\"${{ secrets.FEISHU_APP_ID }}\",\"app_secret\":\"${{ secrets.FEISHU_APP_SECRET }}\"}" \
            https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal)
          
          CODE=$(echo $RESPONSE | jq -r '.code')
          if [ "$CODE" != "0" ]; then
            echo "Failed to get token: $RESPONSE"
            exit 1
          fi
          
          TOKEN=$(echo $RESPONSE | jq -r '.tenant_access_token')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "Token acquired."

      - name: Send to Feishu
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          FEISHU_TOKEN: ${{ steps.token.outputs.token }}
          FEISHU_RECEIVE_ID: ${{ secrets.FEISHU_RECEIVE_ID }}
          # âš ï¸ é‡è¦ï¼šå¦‚æœæ˜¯ç¾¤èŠï¼Œè¯·æ”¹ä¸º chat_idï¼›å¦‚æœæ˜¯ä¸ªäººï¼Œä¿æŒ open_id
          RECEIVE_ID_TYPE: "open_id" 
          FILE_PATH: ${{ steps.changed-files.outputs.all_changed_files }}
          REPO_URL: https://github.com/${{ github.repository }}/blob/main
        run: |
          # è·å–ç¬¬ä¸€ä¸ªå˜åŒ–çš„æ–‡ä»¶è·¯å¾„
          FIRST_FILE=$(echo "$FILE_PATH" | awk '{print $1}')
          
          if [ -z "$FIRST_FILE" ]; then
            echo "No files changed."
            exit 0
          fi
          
          FILENAME=$(basename "$FIRST_FILE")
          # è¯»å–å†…å®¹å¹¶ç®€å•è½¬ä¹‰ (æ›¿æ¢æ¢è¡Œç¬¦ä¸º \nï¼Œæ›¿æ¢åŒå¼•å·ä¸º \" )
          # æ³¨æ„ï¼šè¿™é‡Œä¸ºäº†ç¨³å¥ï¼Œåªå–å‰ 500 ä¸ªå­—ç¬¦ï¼Œé˜²æ­¢å†…å®¹è¿‡é•¿å¯¼è‡´ JSON çˆ†ç‚¸
          CONTENT=$(cat "$FIRST_FILE" | head -20 | tr '\n' ' ' | sed 's/"/\\"/g' | cut -c 1-500)
          
          echo "Sending notification for: $FILENAME"
          
          # å‘é€è¯·æ±‚
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $FEISHU_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"receive_id\": \"$FEISHU_RECEIVE_ID\",
              \"msg_type\": \"interactive\",
              \"content\": {
                \"card\": {
                  \"header\": {
                    \"title\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"ğŸ“š $FILENAME\"
                    },
                    \"template\": \"blue\"
                  },
                  \"elements\": [
                    {
                      \"tag\": \"div\",
                      \"text\": {
                        \"tag\": \"lark_md\",
                        \"content\": \"$CONTENT\"
                      }
                    },
                    {
                      \"tag\": \"action\",
                      \"actions\": [
                        {
                          \"tag\": \"button\",
                          \"text\": {
                            \"tag\": \"plain_text\",
                            \"content\": \"æŸ¥çœ‹åŸæ–‡\"
                          },
                          \"url\": \"$REPO_URL/$FIRST_FILE\",
                          \"type\": \"primary\"
                        }
                      ]
                    }
                  ]
                }
              }
            }" \
            "https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=$RECEIVE_ID_TYPE")
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "âœ… Success! Message sent."
          else
            echo "âŒ Failed with HTTP code: $HTTP_CODE"
            exit 1
          fi
