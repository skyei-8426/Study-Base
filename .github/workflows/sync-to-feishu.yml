name: Sync to Feishu

on:
  push:
    paths:
      - 'docs/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: docs/**.md
      
      - name: Get Feishu Tenant Access Token
        id: token
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ”„ Requesting Feishu Token..."
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"app_id\":\"${{ secrets.FEISHU_APP_ID }}\",\"app_secret\":\"${{ secrets.FEISHU_APP_SECRET }}\"}" \
            https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal)
          
          code=$(echo "$response" | jq -r '.code')
          if [ "$code" != "0" ]; then
            echo "âŒ Failed to get token: $response"
            exit 1
          fi
          
          token=$(echo "$response" | jq -r '.tenant_access_token')
          echo "token=$token" >> $GITHUB_OUTPUT
          echo "âœ… Token acquired."
      
      - name: Send to Feishu
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          FEISHU_TOKEN: ${{ steps.token.outputs.token }}
          FEISHU_RECEIVE_ID: ${{ secrets.FEISHU_RECEIVE_ID }}
          REPO_URL: https://github.com/${{ github.repository }}/blob/main
        run: |
          # âš ï¸ é‡è¦ï¼šè¯·æ ¹æ®ä½ çš„ ID ç±»å‹ä¿®æ”¹ä¸‹é¢è¿™ä¸€è¡Œ
          # å¦‚æœæ˜¯å‘ç»™ä¸ªäºº (ou_...) å¡« open_id
          # å¦‚æœæ˜¯å‘ç»™ç¾¤ (oc_...) å¡« chat_id
          RECEIVE_ID_TYPE="open_id" 
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            
            # è¯»å–æ–‡ä»¶å‰ 10 è¡Œï¼Œå¹¶è¿›è¡Œä¸¥æ ¼çš„ JSON è½¬ä¹‰
            raw_content=$(cat "$file" | head -10)
            safe_content=$(echo "$raw_content" | jq -Rs '.') 
            
            # æ„å»ºå¡ç‰‡ JSON
